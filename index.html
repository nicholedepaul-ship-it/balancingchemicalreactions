import React, { useState } from 'react';
import { Check, RotateCcw, Beaker, Info, ChevronDown, ChevronUp } from 'lucide-react';

const ChemistryBalancer = () => {
  const [showDefinitions, setShowDefinitions] = useState(false);
  
  // State to track user inputs and validation status
  // Structure: { [problemId]: { inputs: [val1, val2...], status: 'idle' | 'correct' | 'incorrect' } }
  const [problemStates, setProblemStates] = useState({});

  const definitions = [
    { type: "Synthesis", desc: "Two or more substances combine to form a single product.", form: "A + B → AB" },
    { type: "Decomposition", desc: "A single compound breaks down into two or more simpler substances.", form: "AB → A + B" },
    { type: "Single Displacement", desc: "One element replaces another element in a compound.", form: "A + BC → AC + B" },
    { type: "Double Displacement", desc: "Ions of two compounds exchange places in aqueous solution.", form: "AB + CD → AD + CB" },
    { type: "Combustion", desc: "A substance reacts with oxygen, releasing energy (producing CO₂ + H₂O for hydrocarbons).", form: "CxHy + O₂ → CO₂ + H₂O" }
  ];

  const sections = [
    {
      title: "Part I: Synthesis Reactions",
      problems: [
        { id: 1, level: "Basic", parts: [{ formula: "Na" }, { formula: "Cl2" }], products: [{ formula: "NaCl" }], correct: [2, 1, 2] },
        { id: 2, level: "Intermediate", parts: [{ formula: "H2" }, { formula: "O2" }], products: [{ formula: "H2O" }], correct: [2, 1, 2] },
        { id: 3, level: "Advanced", parts: [{ formula: "N2" }, { formula: "H2" }], products: [{ formula: "NH3" }], correct: [1, 3, 2] },
        { id: 4, level: "Challenging", parts: [{ formula: "Al" }, { formula: "O2" }], products: [{ formula: "Al2O3" }], correct: [4, 3, 2] },
        { id: 5, level: "Expert", parts: [{ formula: "P4" }, { formula: "O2" }], products: [{ formula: "P4O10" }], correct: [1, 5, 1] }
      ]
    },
    {
      title: "Part II: Decomposition Reactions",
      problems: [
        { id: 6, level: "Basic", parts: [{ formula: "H2O" }], products: [{ formula: "H2" }, { formula: "O2" }], correct: [2, 2, 1] },
        { id: 7, level: "Intermediate", parts: [{ formula: "HgO" }], products: [{ formula: "Hg" }, { formula: "O2" }], correct: [2, 2, 1] },
        { id: 8, level: "Advanced", parts: [{ formula: "H2O2" }], products: [{ formula: "H2O" }, { formula: "O2" }], correct: [2, 2, 1] },
        { id: 9, level: "Challenging", parts: [{ formula: "KClO3" }], products: [{ formula: "KCl" }, { formula: "O2" }], correct: [2, 2, 3] },
        { id: 10, level: "Expert", parts: [{ formula: "NaN3" }], products: [{ formula: "Na" }, { formula: "N2" }], correct: [2, 2, 3] }
      ]
    },
    {
      title: "Part III: Single Displacement Reactions",
      problems: [
        { id: 11, level: "Basic", parts: [{ formula: "Zn" }, { formula: "HCl" }], products: [{ formula: "ZnCl2" }, { formula: "H2" }], correct: [1, 2, 1, 1] },
        { id: 12, level: "Intermediate", parts: [{ formula: "F2" }, { formula: "NaCl" }], products: [{ formula: "NaF" }, { formula: "Cl2" }], correct: [1, 2, 2, 1] },
        { id: 13, level: "Advanced", parts: [{ formula: "Al" }, { formula: "Fe2O3" }], products: [{ formula: "Al2O3" }, { formula: "Fe" }], correct: [2, 1, 1, 2] },
        { id: 14, level: "Challenging", parts: [{ formula: "Cu" }, { formula: "AgNO3" }], products: [{ formula: "Cu(NO3)2" }, { formula: "Ag" }], correct: [1, 2, 1, 2] },
        { id: 15, level: "Expert", parts: [{ formula: "Al" }, { formula: "CuCl2" }], products: [{ formula: "AlCl3" }, { formula: "Cu" }], correct: [2, 3, 2, 3] }
      ]
    },
    {
      title: "Part IV: Double Displacement Reactions",
      problems: [
        { id: 16, level: "Basic", parts: [{ formula: "AgNO3" }, { formula: "NaCl" }], products: [{ formula: "AgCl" }, { formula: "NaNO3" }], correct: [1, 1, 1, 1] },
        { id: 17, level: "Intermediate", parts: [{ formula: "KI" }, { formula: "Pb(NO3)2" }], products: [{ formula: "PbI2" }, { formula: "KNO3" }], correct: [2, 1, 1, 2] },
        { id: 18, level: "Advanced", parts: [{ formula: "FeCl3" }, { formula: "NaOH" }], products: [{ formula: "Fe(OH)3" }, { formula: "NaCl" }], correct: [1, 3, 1, 3] },
        { id: 19, level: "Challenging", parts: [{ formula: "Ca(OH)2" }, { formula: "H3PO4" }], products: [{ formula: "Ca3(PO4)2" }, { formula: "H2O" }], correct: [3, 2, 1, 6] },
        { id: 20, level: "Expert", parts: [{ formula: "Al2(SO4)3" }, { formula: "Ca(OH)2" }], products: [{ formula: "Al(OH)3" }, { formula: "CaSO4" }], correct: [1, 3, 2, 3] }
      ]
    },
    {
      title: "Part V: Combustion Reactions",
      problems: [
        { id: 21, level: "Basic", parts: [{ formula: "CH4" }, { formula: "O2" }], products: [{ formula: "CO2" }, { formula: "H2O" }], correct: [1, 2, 1, 2] },
        { id: 22, level: "Intermediate", parts: [{ formula: "C3H8" }, { formula: "O2" }], products: [{ formula: "CO2" }, { formula: "H2O" }], correct: [1, 5, 3, 4] },
        { id: 23, level: "Advanced", parts: [{ formula: "CH3OH" }, { formula: "O2" }], products: [{ formula: "CO2" }, { formula: "H2O" }], correct: [2, 3, 2, 4] },
        { id: 24, level: "Challenging", parts: [{ formula: "C2H6" }, { formula: "O2" }], products: [{ formula: "CO2" }, { formula: "H2O" }], correct: [2, 7, 4, 6] },
        { id: 25, level: "Expert", parts: [{ formula: "C4H10" }, { formula: "O2" }], products: [{ formula: "CO2" }, { formula: "H2O" }], correct: [2, 13, 8, 10] }
      ]
    }
  ];

  const handleInputChange = (problemId, index, value) => {
    // Only allow numbers
    if (value && !/^\d*$/.test(value)) return;

    setProblemStates(prev => {
      const currentProblem = prev[problemId] || { inputs: [], status: 'idle' };
      const newInputs = [...(currentProblem.inputs || [])];
      newInputs[index] = value;
      return {
        ...prev,
        [problemId]: { ...currentProblem, inputs: newInputs, status: 'idle' }
      };
    });
  };

  const checkAnswer = (problemId, correctParams) => {
    const currentState = problemStates[problemId];
    if (!currentState) return;

    const userInputs = currentState.inputs || [];
    
    // Treat empty or '0' as '1' for checking logic, but encourage explicit input
    // However, in chemistry apps, blank usually implies 1, but for practice we might require explicit input
    // Let's go with: Blank is interpreted as 1, but strict matching to the answer key
    // The Answer Key provided in the prompt implies reduced forms.
    
    const parsedInputs = userInputs.map(i => (i === '' || i === undefined) ? 1 : parseInt(i, 10));
    
    // Fill in trailing blanks if user didn't type in the last boxes (though UI renders all boxes)
    // We need to match the length of correctParams
    const fullInputs = [];
    for(let i=0; i<correctParams.length; i++) {
        fullInputs.push(parsedInputs[i] || 1);
    }

    const isCorrect = fullInputs.every((val, idx) => val === correctParams[idx]);

    setProblemStates(prev => ({
      ...prev,
      [problemId]: { ...prev[problemId], status: isCorrect ? 'correct' : 'incorrect' }
    }));
  };

  const formatFormula = (formula) => {
    // Split by numbers to subscript them
    const parts = formula.split(/(\d+)/).filter(Boolean);
    return (
      <span>
        {parts.map((part, i) => 
          /^\d+$/.test(part) ? <sub key={i} className="text-xs">{part}</sub> : <span key={i}>{part}</span>
        )}
      </span>
    );
  };

  const renderFormulaWithInput = (problem, part, index, globalInputIndex) => {
    const inputValue = problemStates[problem.id]?.inputs?.[globalInputIndex] ?? '';
    const status = problemStates[problem.id]?.status;
    
    let borderColor = "border-gray-300 focus:border-blue-500 focus:ring-blue-200";
    if (status === 'correct') borderColor = "border-green-500 bg-green-50 text-green-700 font-bold";
    else if (status === 'incorrect') borderColor = "border-red-500 bg-red-50";

    return (
      <div key={`part-${index}`} className="flex items-center gap-1 sm:gap-2">
        {index > 0 && <span className="text-gray-500 font-bold">+</span>}
        <input 
          type="text" 
          inputMode="numeric"
          className={`w-10 h-10 sm:w-12 sm:h-12 text-center border-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 transition-colors ${borderColor}`}
          placeholder="1"
          value={inputValue}
          onChange={(e) => handleInputChange(problem.id, globalInputIndex, e.target.value)}
          disabled={status === 'correct'}
        />
        <span className="text-lg sm:text-xl font-medium text-gray-700 tracking-wide font-mono">
          {formatFormula(part.formula)}
        </span>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 sm:p-6 lg:p-8">
      <div className="max-w-4xl mx-auto space-y-8">
        
        {/* Header */}
        <header className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <h1 className="text-3xl font-extrabold text-slate-900 flex items-center gap-3">
                <Beaker className="w-8 h-8 text-blue-600" />
                Chemistry Activity
              </h1>
              <p className="text-slate-500 mt-2">
                Balance the equations and master the 5 standard reaction types.
              </p>
            </div>
            <button 
              onClick={() => setShowDefinitions(!showDefinitions)}
              className="flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors font-medium"
            >
              <Info className="w-4 h-4" />
              {showDefinitions ? "Hide Review" : "Review Types"}
              {showDefinitions ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            </button>
          </div>

          {/* Collapsible Definitions */}
          {showDefinitions && (
            <div className="mt-6 grid gap-4 md:grid-cols-2 lg:grid-cols-3 animate-in fade-in slide-in-from-top-4 duration-300">
              {definitions.map((def, i) => (
                <div key={i} className="p-4 rounded-xl bg-slate-50 border border-slate-100 hover:border-blue-200 transition-colors">
                  <h3 className="font-bold text-blue-800 mb-1">{def.type}</h3>
                  <p className="text-xs text-slate-500 font-mono mb-2 bg-white inline-block px-1 rounded">{def.form}</p>
                  <p className="text-sm text-slate-600 leading-snug">{def.desc}</p>
                </div>
              ))}
            </div>
          )}
        </header>

        {/* Sections */}
        {sections.map((section, sIdx) => (
          <div key={sIdx} className="space-y-4">
            <h2 className="text-xl font-bold text-slate-700 border-b-2 border-blue-100 pb-2 flex items-center">
              <span className="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded mr-3 uppercase tracking-wider">
                Part {sIdx + 1}
              </span>
              {section.title.split(': ')[1]}
            </h2>
            
            <div className="grid gap-4">
              {section.problems.map((problem) => {
                const totalReactants = problem.parts.length;
                const status = problemStates[problem.id]?.status;

                return (
                  <div 
                    key={problem.id} 
                    className={`
                      relative group bg-white rounded-xl border-l-4 p-5 shadow-sm transition-all
                      ${status === 'correct' ? 'border-l-green-500 shadow-green-100' : 'border-l-blue-500 hover:shadow-md'}
                    `}
                  >
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                      <span className="text-xs font-semibold text-slate-400 uppercase tracking-widest">
                        Level {problem.id % 5 === 0 ? 5 : problem.id % 5}: {problem.level}
                      </span>
                      {status === 'correct' && (
                        <span className="flex items-center text-green-600 font-bold text-sm bg-green-50 px-2 py-1 rounded-full">
                          <Check className="w-4 h-4 mr-1" /> Balanced
                        </span>
                      )}
                      {status === 'incorrect' && (
                        <span className="text-red-500 font-bold text-sm bg-red-50 px-2 py-1 rounded-full animate-pulse">
                          Try Again
                        </span>
                      )}
                    </div>

                    {/* Equation Display */}
                    <div className="flex flex-wrap items-center gap-2 sm:gap-3 mb-6 justify-center sm:justify-start">
                      {/* Reactants */}
                      {problem.parts.map((part, i) => renderFormulaWithInput(problem, part, i, i))}
                      
                      {/* Arrow */}
                      <div className="mx-2 text-slate-400">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                      </div>

                      {/* Products */}
                      {problem.products.map((prod, i) => renderFormulaWithInput(problem, prod, i, i + totalReactants))}
                    </div>

                    {/* Controls */}
                    <div className="flex justify-end">
                      <button
                        onClick={() => checkAnswer(problem.id, problem.correct)}
                        disabled={status === 'correct'}
                        className={`
                          flex items-center gap-2 px-6 py-2 rounded-lg font-semibold transition-all
                          ${status === 'correct' 
                            ? 'bg-gray-100 text-gray-400 cursor-default' 
                            : 'bg-blue-600 text-white hover:bg-blue-700 active:scale-95 shadow-lg shadow-blue-200'
                          }
                        `}
                      >
                        {status === 'correct' ? 'Solved' : 'Check'}
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        ))}

        {/* Footer */}
        <footer className="text-center text-slate-400 text-sm py-8">
           Chemical Balancing Practice • 25 Problems
        </footer>

      </div>
    </div>
  );
};

export default ChemistryBalancer;
